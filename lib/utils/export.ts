import jsPDF from 'jspdf';
import Papa from 'papaparse';

// ============================================
// PDF EXPORT UTILITIES
// ============================================

/**
 * –≠–∫—Å–ø–æ—Ä—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –≤ PDF
 */
export function exportComparisonToPDF(data: {
    repos: Array<{
        name: string;
        owner: string;
        stars: number;
        forks: number;
        watchers: number;
        issues: number;
        contributors: number;
        languages: number;
        created: string;
        license: string;
    }>;
}) {
    const doc = new jsPDF();

    // Title
    doc.setFontSize(20);
    doc.text('GitHub Repository Comparison', 20, 20);

    // Date
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 30);

    // Reset color
    doc.setTextColor(0);

    let yPos = 45;

    data.repos.forEach((repo, index) => {
        // Repository Header
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(`${index + 1}. ${repo.owner}/${repo.name}`, 20, yPos);
        yPos += 8;

        // Metrics
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');

        const metrics = [
            `‚≠ê Stars: ${repo.stars.toLocaleString()}`,
            `üî± Forks: ${repo.forks.toLocaleString()}`,
            `üëÅ Watchers: ${repo.watchers.toLocaleString()}`,
            `üêõ Open Issues: ${repo.issues.toLocaleString()}`,
            `üë• Contributors: ${repo.contributors}+`,
            `üíª Languages: ${repo.languages}`,
            `üìÖ Created: ${repo.created}`,
            `‚öñ License: ${repo.license}`,
        ];

        metrics.forEach((metric) => {
            doc.text(metric, 25, yPos);
            yPos += 6;
        });

        yPos += 5;

        // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –µ—Å–ª–∏ –º–µ—Å—Ç–∞ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç
        if (yPos > 270 && index < data.repos.length - 1) {
            doc.addPage();
            yPos = 20;
        }
    });

    // Footer
    const pageCount = doc.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(
            `Generated by GitHub Explorer - Page ${i} of ${pageCount}`,
            20,
            doc.internal.pageSize.height - 10
        );
    }

    // Download
    doc.save(`github-comparison-${Date.now()}.pdf`);
}

/**
 * –≠–∫—Å–ø–æ—Ä—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ PDF
 */
export function exportRepoStatsToPDF(data: {
    name: string;
    owner: string;
    description: string;
    stars: number;
    forks: number;
    watchers: number;
    issues: number;
    language: string;
    license: string;
    created: string;
    updated: string;
    contributors: Array<{ login: string; contributions: number }>;
    languages: Array<{ name: string; percentage: number }>;
}) {
    const doc = new jsPDF();

    // Header
    doc.setFontSize(22);
    doc.setTextColor(20, 184, 166); // teal
    doc.text(`${data.owner}/${data.name}`, 20, 20);

    // Description
    doc.setFontSize(10);
    doc.setTextColor(100);
    const splitDescription = doc.splitTextToSize(
        data.description || 'No description',
        170
    );
    doc.text(splitDescription, 20, 30);

    let yPos = 30 + splitDescription.length * 5 + 10;

    // Main Metrics Section
    doc.setFontSize(14);
    doc.setTextColor(0);
    doc.setFont('helvetica', 'bold');
    doc.text('üìä Key Metrics', 20, yPos);
    yPos += 10;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');

    const mainMetrics = [
        `‚≠ê Stars: ${data.stars.toLocaleString()}`,
        `üî± Forks: ${data.forks.toLocaleString()}`,
        `üëÅ Watchers: ${data.watchers.toLocaleString()}`,
        `üêõ Open Issues: ${data.issues.toLocaleString()}`,
        `üíª Primary Language: ${data.language}`,
        `‚öñ License: ${data.license}`,
        `üìÖ Created: ${data.created}`,
        `üîÑ Last Updated: ${data.updated}`,
    ];

    mainMetrics.forEach((metric) => {
        doc.text(metric, 25, yPos);
        yPos += 7;
    });

    yPos += 10;

    // Top Contributors
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('üë• Top Contributors', 20, yPos);
    yPos += 10;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');

    data.contributors.slice(0, 10).forEach((contributor, index) => {
        doc.text(
            `${index + 1}. ${contributor.login} - ${contributor.contributions} commits`,
            25,
            yPos
        );
        yPos += 6;
    });

    yPos += 10;

    // Languages
    if (yPos > 250) {
        doc.addPage();
        yPos = 20;
    }

    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('üíª Languages Distribution', 20, yPos);
    yPos += 10;

    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');

    data.languages.forEach((lang) => {
        doc.text(`${lang.name}: ${lang.percentage.toFixed(1)}%`, 25, yPos);
        yPos += 6;
    });

    // Footer
    doc.setFontSize(8);
    doc.setTextColor(150);
    doc.text(
        `Generated by GitHub Explorer on ${new Date().toLocaleDateString()}`,
        20,
        doc.internal.pageSize.height - 10
    );

    // Download
    doc.save(`${data.owner}-${data.name}-stats-${Date.now()}.pdf`);
}

// ============================================
// CSV EXPORT UTILITIES
// ============================================

/**
 * –≠–∫—Å–ø–æ—Ä—Ç trending —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –≤ CSV
 */
export function exportTrendingToCSV(data: {
    repos: Array<{
        rank: number;
        name: string;
        owner: string;
        description: string;
        stars: number;
        forks: number;
        language: string;
        url: string;
    }>;
    since: string;
    language?: string;
}) {
    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    const csvData = data.repos.map((repo) => ({
        Rank: repo.rank,
        Repository: `${repo.owner}/${repo.name}`,
        Description: repo.description || '',
        Stars: repo.stars,
        Forks: repo.forks,
        Language: repo.language || 'N/A',
        URL: repo.url,
    }));

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è CSV
    const csv = Papa.unparse(csvData);

    // –°–æ–∑–¥–∞–Ω–∏–µ Blob –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    const filename = `trending-${data.since}${
        data.language ? `-${data.language.toLowerCase()}` : ''
    }-${Date.now()}.csv`;

    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

/**
 * –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –≤ CSV
 */
export function exportSearchResultsToCSV(data: {
    repos: Array<{
        name: string;
        owner: string;
        description: string;
        stars: number;
        forks: number;
        watchers: number;
        language: string;
        url: string;
    }>;
    query: string;
}) {
    const csvData = data.repos.map((repo) => ({
        Repository: `${repo.owner}/${repo.name}`,
        Description: repo.description || '',
        Stars: repo.stars,
        Forks: repo.forks,
        Watchers: repo.watchers,
        Language: repo.language || 'N/A',
        URL: repo.url,
    }));

    const csv = Papa.unparse(csvData);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    link.setAttribute('href', url);
    link.setAttribute('download', `search-${data.query}-${Date.now()}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
